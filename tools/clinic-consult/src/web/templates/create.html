<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìƒˆ ì˜ˆì•½ ë“±ë¡</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          borderRadius: { lg: 'var(--radius)' },
          colors: {
            border: 'hsl(var(--border))',
            input: 'hsl(var(--input))',
            ring: 'hsl(var(--ring))',
            background: 'hsl(var(--background))',
            foreground: 'hsl(var(--foreground))',
            primary: { DEFAULT: 'hsl(var(--primary))', foreground: 'hsl(var(--primary-foreground))' },
            secondary: { DEFAULT: 'hsl(var(--secondary))', foreground: 'hsl(var(--secondary-foreground))' },
            destructive: { DEFAULT: 'hsl(var(--destructive))', foreground: 'hsl(var(--destructive-foreground))' },
            muted: { DEFAULT: 'hsl(var(--muted))', foreground: 'hsl(var(--muted-foreground))' },
            accent: { DEFAULT: 'hsl(var(--accent))', foreground: 'hsl(var(--accent-foreground))' },
            card: { DEFAULT: 'hsl(var(--card))', foreground: 'hsl(var(--card-foreground))' },
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 240 10% 3.9%;
      --card: 0 0% 100%;
      --card-foreground: 240 10% 3.9%;
      --primary: 240 5.9% 10%;
      --primary-foreground: 0 0% 98%;
      --secondary: 240 4.8% 95.9%;
      --secondary-foreground: 240 5.9% 10%;
      --muted: 240 4.8% 95.9%;
      --muted-foreground: 240 3.8% 46.1%;
      --accent: 240 4.8% 95.9%;
      --accent-foreground: 240 5.9% 10%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 0 0% 98%;
      --border: 240 5.9% 90%;
      --input: 240 5.9% 90%;
      --ring: 240 5.9% 10%;
      --radius: 0.5rem;
    }
    body { font-family: 'Inter', system-ui, sans-serif; }
  </style>
</head>
<body class="bg-background text-foreground min-h-screen">
  <!-- Header -->
  <header class="border-b border-border bg-gradient-to-r from-card to-secondary/50">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 py-6">
      <a href="/" class="inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors mb-4">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        ëŒ€ì‹œë³´ë“œ
      </a>
      <h1 class="text-2xl font-bold tracking-tight text-foreground">ìƒˆ ì˜ˆì•½ ë“±ë¡</h1>
      <p class="text-sm text-muted-foreground mt-1">ì™¸êµ­ì¸ í™˜ì ì˜ˆì•½ ìš”ì²­ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤</p>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 sm:px-6 py-6">
    <form method="POST" action="/create" class="space-y-6">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <!-- Clinic Information -->
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="border-b border-border px-6 py-4">
          <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
            <i data-lucide="building-2" class="w-4 h-4 text-muted-foreground"></i>
            í´ë¦¬ë‹‰ ì •ë³´
          </h2>
        </div>
        <div class="px-6 py-5 space-y-4">
          <div class="relative" id="autocomplete-wrapper">
            <label for="clinic_name" class="block text-sm font-medium text-foreground mb-1.5">í´ë¦¬ë‹‰ëª… <span class="text-destructive">*</span></label>
            <input type="text" id="clinic_name" name="clinic_name" required
                   placeholder="í´ë¦¬ë‹‰ëª… ê²€ìƒ‰..."
                   autocomplete="off"
                   class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            <div id="clinic-list" class="absolute top-full left-0 right-0 z-10 mt-1 hidden max-h-52 overflow-y-auto rounded-md border border-border bg-card shadow-lg"></div>
            <p class="text-xs text-muted-foreground mt-1.5">ì¹´ì¹´ì˜¤í†¡ ë˜ëŠ” LINEì´ ìˆëŠ” í´ë¦¬ë‹‰ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>
          </div>
          <div>
            <label for="procedure_name" class="block text-sm font-medium text-foreground mb-1.5">ì‹œìˆ ëª… <span class="text-destructive">*</span></label>
            <input type="text" id="procedure_name" name="procedure_name" required
                   placeholder="ì˜ˆ: ë³´í†¡ìŠ¤, ë ˆì´ì €í† ë‹, í•„ëŸ¬"
                   class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
          </div>
        </div>
      </div>

      <!-- Schedule -->
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="border-b border-border px-6 py-4">
          <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-muted-foreground"></i>
            ì¼ì •
          </h2>
        </div>
        <div class="px-6 py-5 space-y-4">
          <div>
            <label class="block text-sm font-medium text-foreground mb-1.5">í¬ë§ ë‚ ì§œ</label>
            <input type="hidden" id="preferred_dates" name="preferred_dates" value="">
            <div class="flex gap-2">
              <input type="date" id="date_picker"
                     class="flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
              <button type="button" id="add_date_btn"
                      class="inline-flex items-center gap-1.5 rounded-md border border-input bg-background px-3 py-2 text-sm font-medium text-foreground shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                ì¶”ê°€
              </button>
            </div>
            <div id="selected_dates" class="flex flex-wrap gap-1.5 mt-2"></div>
            <p class="text-xs text-muted-foreground mt-1.5">ì—¬ëŸ¬ ë‚ ì§œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
          </div>
          <div>
            <label for="preferred_time" class="block text-sm font-medium text-foreground mb-1.5">í¬ë§ ì‹œê°„</label>
            <select id="preferred_time" name="preferred_time"
                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
              <option value="any">ìƒê´€ì—†ìŒ</option>
              <option value="morning">ì˜¤ì „ (AM)</option>
              <option value="afternoon">ì˜¤í›„ (PM)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Patient Information -->
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="border-b border-border px-6 py-4">
          <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
            <i data-lucide="user" class="w-4 h-4 text-muted-foreground"></i>
            í™˜ì ì •ë³´
          </h2>
        </div>
        <div class="px-6 py-5 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="patient_name" class="block text-sm font-medium text-foreground mb-1.5">í™˜ìëª… <span class="text-destructive">*</span></label>
              <input type="text" id="patient_name" name="patient_name" required
                     class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            </div>
            <div>
              <label for="patient_nationality" class="block text-sm font-medium text-foreground mb-1.5">êµ­ì </label>
              <select id="patient_nationality" name="patient_nationality"
                      class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="JP">Japan</option>
                <option value="CN">China</option>
                <option value="TW">Taiwan</option>
                <option value="MY">Malaysia</option>
                <option value="US">USA</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="patient_age" class="block text-sm font-medium text-foreground mb-1.5">ë‚˜ì´</label>
              <input type="number" id="patient_age" name="patient_age"
                     min="1" max="120" placeholder="ì˜ˆ: 35"
                     class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            </div>
            <div>
              <label for="patient_gender" class="block text-sm font-medium text-foreground mb-1.5">ì„±ë³„</label>
              <select id="patient_gender" name="patient_gender"
                      class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="">ë¯¸ì§€ì •</option>
                <option value="F">ì—¬ì„±</option>
                <option value="M">ë‚¨ì„±</option>
              </select>
            </div>
          </div>
          <div>
            <label for="patient_contact" class="block text-sm font-medium text-foreground mb-1.5">ì—°ë½ì²˜</label>
            <input type="text" id="patient_contact" name="patient_contact"
                   placeholder="ì˜ˆ: LINE: tanaka_yuki"
                   class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="border-b border-border px-6 py-4">
          <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4 text-muted-foreground"></i>
            ë©”ëª¨
          </h2>
        </div>
        <div class="px-6 py-5">
          <textarea id="notes" name="notes"
                    placeholder="ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ë‚˜ ì•ˆë‚´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    rows="3"
                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-y min-h-[80px]"></textarea>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit"
              class="w-full inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
        <i data-lucide="plus" class="w-4 h-4"></i>
        ì˜ˆì•½ ë“±ë¡
      </button>
    </form>
  </main>

  <script>
    lucide.createIcons();

    // --- Date picker logic ---
    const datePicker = document.getElementById('date_picker');
    const addDateBtn = document.getElementById('add_date_btn');
    const selectedDatesContainer = document.getElementById('selected_dates');
    const hiddenDates = document.getElementById('preferred_dates');
    const selectedDates = [];

    function updateHiddenDates() {
      hiddenDates.value = selectedDates.join(', ');
    }

    function removeDate(date) {
      const idx = selectedDates.indexOf(date);
      if (idx > -1) { selectedDates.splice(idx, 1); }
      renderDateTags();
      updateHiddenDates();
    }

    function renderDateTags() {
      selectedDatesContainer.replaceChildren();
      selectedDates.forEach(function(date) {
        const tag = document.createElement('span');
        tag.className = 'inline-flex items-center gap-1 rounded-full bg-primary/10 text-primary px-2.5 py-1 text-xs font-medium';
        tag.innerHTML = '<i data-lucide="calendar" class="w-3 h-3"></i>' + date +
          '<button type="button" class="ml-0.5 hover:text-destructive transition-colors" aria-label="Remove">' +
          '<i data-lucide="x" class="w-3 h-3"></i></button>';
        tag.querySelector('button').addEventListener('click', function() { removeDate(date); });
        selectedDatesContainer.appendChild(tag);
      });
      lucide.createIcons();
    }

    addDateBtn.addEventListener('click', function() {
      const val = datePicker.value;
      if (val && !selectedDates.includes(val)) {
        selectedDates.push(val);
        selectedDates.sort();
        renderDateTags();
        updateHiddenDates();
        datePicker.value = '';
      }
    });

    datePicker.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addDateBtn.click(); }
    });

    // --- Clinic autocomplete ---
    const clinicInput = document.getElementById('clinic_name');
    const clinicList = document.getElementById('clinic-list');
    let debounceTimer;

    function createAutocompleteItem(clinic) {
      const div = document.createElement('div');
      div.className = 'px-3 py-2.5 cursor-pointer text-sm hover:bg-accent transition-colors border-b border-border last:border-0';
      div.dataset.name = clinic.name;

      const nameSpan = document.createElement('span');
      nameSpan.className = 'font-medium text-foreground';
      nameSpan.textContent = clinic.name;
      div.appendChild(nameSpan);

      if (clinic.platforms && clinic.platforms.length > 0) {
        clinic.platforms.forEach(function(p) {
          const dot = document.createElement('span');
          dot.className = 'inline-block w-2 h-2 rounded-full ml-1.5';
          if (p === 'kakao') {
            dot.style.backgroundColor = '#fee500';
            dot.title = 'KakaoTalk';
          } else {
            dot.style.backgroundColor = '#06c755';
            dot.title = 'LINE';
          }
          div.appendChild(dot);
        });
      }

      div.appendChild(document.createElement('br'));

      const metaSpan = document.createElement('span');
      metaSpan.className = 'text-xs text-muted-foreground';
      metaSpan.textContent = clinic.address || '';
      div.appendChild(metaSpan);

      return div;
    }

    clinicInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const q = this.value.trim();
      if (q.length < 1) { clinicList.classList.add('hidden'); return; }
      debounceTimer = setTimeout(() => {
        fetch('/api/clinics/search?q=' + encodeURIComponent(q))
          .then(r => r.json())
          .then(data => {
            if (data.length === 0) { clinicList.classList.add('hidden'); return; }
            clinicList.replaceChildren();
            data.forEach(c => clinicList.appendChild(createAutocompleteItem(c)));
            clinicList.classList.remove('hidden');
          });
      }, 200);
    });

    clinicList.addEventListener('click', function(e) {
      const item = e.target.closest('[data-name]');
      if (item) {
        clinicInput.value = item.dataset.name;
        clinicList.classList.add('hidden');
      }
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('#autocomplete-wrapper')) {
        clinicList.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
