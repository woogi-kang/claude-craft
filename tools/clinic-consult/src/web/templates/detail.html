<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜ˆì•½ {{ reservation.request_id }}</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          borderRadius: { lg: 'var(--radius)' },
          colors: {
            border: 'hsl(var(--border))',
            input: 'hsl(var(--input))',
            ring: 'hsl(var(--ring))',
            background: 'hsl(var(--background))',
            foreground: 'hsl(var(--foreground))',
            primary: { DEFAULT: 'hsl(var(--primary))', foreground: 'hsl(var(--primary-foreground))' },
            secondary: { DEFAULT: 'hsl(var(--secondary))', foreground: 'hsl(var(--secondary-foreground))' },
            destructive: { DEFAULT: 'hsl(var(--destructive))', foreground: 'hsl(var(--destructive-foreground))' },
            muted: { DEFAULT: 'hsl(var(--muted))', foreground: 'hsl(var(--muted-foreground))' },
            accent: { DEFAULT: 'hsl(var(--accent))', foreground: 'hsl(var(--accent-foreground))' },
            card: { DEFAULT: 'hsl(var(--card))', foreground: 'hsl(var(--card-foreground))' },
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 240 10% 3.9%;
      --card: 0 0% 100%;
      --card-foreground: 240 10% 3.9%;
      --primary: 240 5.9% 10%;
      --primary-foreground: 0 0% 98%;
      --secondary: 240 4.8% 95.9%;
      --secondary-foreground: 240 5.9% 10%;
      --muted: 240 4.8% 95.9%;
      --muted-foreground: 240 3.8% 46.1%;
      --accent: 240 4.8% 95.9%;
      --accent-foreground: 240 5.9% 10%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 0 0% 98%;
      --border: 240 5.9% 90%;
      --input: 240 5.9% 90%;
      --ring: 240 5.9% 10%;
      --radius: 0.5rem;
    }
    body { font-family: 'Inter', system-ui, sans-serif; }
  </style>
</head>
<body class="bg-background text-foreground min-h-screen">
  <!-- Header -->
  <header class="border-b border-border bg-gradient-to-r from-card to-secondary/50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-6">
      <a href="/" class="inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors mb-4">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        ëŒ€ì‹œë³´ë“œ
      </a>
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-foreground">{{ reservation.clinic_name }}</h1>
          <p class="text-sm text-muted-foreground mt-0.5 tabular-nums">{{ reservation.request_id }}</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          {% set b = badge(reservation.status) %}
          {% if reservation.status == 'confirmed' or reservation.status == 'completed' %}
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-emerald-100 text-emerald-700">{{ b.label }}</span>
          {% elif reservation.status == 'negotiating' or reservation.status == 'contacting' or reservation.status == 'greeting_sent' %}
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-amber-100 text-amber-700">{{ b.label }}</span>
          {% elif reservation.status == 'paused_for_human' %}
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-red-100 text-red-700">{{ b.label }}</span>
          {% elif reservation.status == 'declined' or reservation.status == 'failed' or reservation.status == 'timed_out' %}
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-gray-100 text-gray-600">{{ b.label }}</span>
          {% else %}
          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold bg-secondary text-secondary-foreground">{{ b.label }}</span>
          {% endif %}

          {% if valid_transitions %}
          <form method="POST" action="/reservations/{{ reservation.id }}/status" class="inline-flex items-center gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <select name="new_status"
                    class="rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
              {% for status_val in valid_transitions %}
              <option value="{{ status_val }}">{{ badge(status_val).label }}</option>
              {% endfor %}
            </select>
            <button type="submit"
                    class="inline-flex items-center gap-1.5 rounded-md bg-primary px-3 py-1.5 text-xs font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
              <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
              ë³€ê²½
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-6 space-y-4">
    <!-- Paused Alert -->
    {% if reservation.status == 'paused_for_human' %}
    <div class="flex items-start gap-3 rounded-lg border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-800">
      <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0 text-amber-500 mt-0.5"></i>
      <div>
        <p class="font-semibold">ì´ ì˜ˆì•½ì´ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤: <span class="font-normal">{{ reservation.paused_reason or 'ë‹´ë‹¹ì í™•ì¸ í•„ìš”' }}</span></p>
        <p class="text-amber-700 mt-1">ì•„ë˜ ì–‘ì‹ìœ¼ë¡œ ì§ì ‘ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì¬ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
    {% endif %}

    <!-- Reservation Details -->
    <div class="rounded-lg border border-border bg-card shadow-sm">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
          <i data-lucide="clipboard-list" class="w-4 h-4 text-muted-foreground"></i>
          ì˜ˆì•½ ìƒì„¸
        </h2>
      </div>
      <div class="px-6 py-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6">
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ì‹œìˆ </p>
            <p class="text-sm font-medium">{{ reservation.procedure_name }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">í¬ë§ ë‚ ì§œ</p>
            <p class="text-sm font-medium tabular-nums">
              {% if reservation.preferred_dates %}
                {% set dates = json_loads(reservation.preferred_dates) if reservation.preferred_dates and reservation.preferred_dates.startswith('[') else [reservation.preferred_dates] %}
                {{ dates | join(', ') }}
              {% else %}
                -
              {% endif %}
            </p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ì„ í˜¸ ì‹œê°„</p>
            <p class="text-sm font-medium">{{ reservation.preferred_time or 'Any' }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ëŒ€í™” íšŸìˆ˜</p>
            <p class="text-sm font-medium tabular-nums">{{ reservation.turn_count or 0 }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Patient Info -->
    <div class="rounded-lg border border-border bg-card shadow-sm">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
          <i data-lucide="user" class="w-4 h-4 text-muted-foreground"></i>
          í™˜ì ì •ë³´
        </h2>
      </div>
      <div class="px-6 py-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6">
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ì´ë¦„</p>
            <p class="text-sm font-medium">{{ reservation.patient_name }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">êµ­ì </p>
            <p class="text-sm font-medium">{{ reservation.patient_nationality }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ë‚˜ì´</p>
            <p class="text-sm font-medium">{{ reservation.patient_age or '-' }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ì„±ë³„</p>
            <p class="text-sm font-medium">{{ reservation.patient_gender or '-' }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ì—°ë½ì²˜</p>
            <p class="text-sm font-medium">{{ reservation.patient_contact or '-' }}</p>
          </div>
          <div>
            <p class="text-xs text-muted-foreground mb-0.5">ë©”ëª¨</p>
            <p class="text-sm font-medium">{{ reservation.notes or '-' }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Result (if confirmed/declined) -->
    {% if reservation.status in ('confirmed', 'completed') and reservation.confirmed_date %}
    <div class="rounded-lg border border-border bg-card shadow-sm">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
          <i data-lucide="calendar-check" class="w-4 h-4 text-emerald-600"></i>
          ì˜ˆì•½ ê²°ê³¼
        </h2>
      </div>
      <div class="px-6 py-5">
        <div class="rounded-md border border-emerald-200 bg-emerald-50 p-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6">
            <div>
              <p class="text-xs text-emerald-600 mb-0.5">ë‚ ì§œ</p>
              <p class="text-sm font-medium tabular-nums">{{ reservation.confirmed_date }}</p>
            </div>
            <div>
              <p class="text-xs text-emerald-600 mb-0.5">ì‹œê°„</p>
              <p class="text-sm font-medium">{{ reservation.confirmed_time or '-' }}</p>
            </div>
            <div>
              <p class="text-xs text-emerald-600 mb-0.5">ê°€ê²©</p>
              <p class="text-sm font-medium">{{ reservation.confirmed_price or '-' }}</p>
            </div>
            <div>
              <p class="text-xs text-emerald-600 mb-0.5">ë‹´ë‹¹ì˜</p>
              <p class="text-sm font-medium">{{ reservation.confirmed_doctor or '-' }}</p>
            </div>
          </div>
          {% if reservation.clinic_instructions %}
          <div class="mt-4 pt-4 border-t border-emerald-200">
            <p class="text-xs text-emerald-600 mb-1">í´ë¦¬ë‹‰ ì•ˆë‚´ì‚¬í•­</p>
            <p class="text-sm">{{ reservation.clinic_instructions }}</p>
          </div>
          {% endif %}
        </div>
        <div class="mt-4 flex items-center gap-2">
          <button onclick="copyForPatient()"
                  class="inline-flex items-center gap-1.5 rounded-md border border-input bg-background px-3 py-1.5 text-xs font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                  aria-label="í™˜ììš© ìš”ì•½ ë³µì‚¬">
            <i data-lucide="copy" class="w-3.5 h-3.5"></i>
            í™˜ììš© ë³µì‚¬
          </button>
          <span class="text-xs text-emerald-600 hidden" id="copied-msg">ë³µì‚¬ë¨!</span>
        </div>
        <div class="hidden mt-3 rounded-md border border-border bg-muted p-4 text-sm whitespace-pre-wrap leading-relaxed" id="patient-summary">í´ë¦¬ë‹‰: {{ reservation.clinic_name }}
ë‚ ì§œ: {{ reservation.confirmed_date }}
ì‹œê°„: {{ reservation.confirmed_time or 'TBD' }}
ì‹œìˆ : {{ reservation.procedure_name }}{% if reservation.confirmed_price %}
ê°€ê²©: {{ reservation.confirmed_price }}{% endif %}{% if reservation.confirmed_doctor %}
ë‹´ë‹¹ì˜: {{ reservation.confirmed_doctor }}{% endif %}{% if reservation.clinic_instructions %}
ì•ˆë‚´ì‚¬í•­: {{ reservation.clinic_instructions }}{% endif %}</div>
      </div>
    </div>
    {% elif reservation.status == 'declined' %}
    <div class="rounded-lg border border-border bg-card shadow-sm">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
          <i data-lucide="x-circle" class="w-4 h-4 text-muted-foreground"></i>
          ê±°ì ˆ ì‚¬ìœ 
        </h2>
      </div>
      <div class="px-6 py-5">
        <div class="rounded-md border border-red-200 bg-red-50 p-4">
          <p class="text-sm text-red-800">{{ reservation.decline_reason or 'ì‚¬ìœ  ì—†ìŒ' }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Conversation Log -->
    <div class="rounded-lg border border-border bg-card shadow-sm">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-sm font-semibold text-foreground flex items-center gap-2">
          <i data-lucide="message-square" class="w-4 h-4 text-muted-foreground"></i>
          ëŒ€í™” ê¸°ë¡
        </h2>
      </div>
      <div class="px-6 py-5">
        <div class="space-y-3">
          {% for msg in messages %}
          <div class="flex {{ 'justify-end' if msg.direction == 'outgoing' else 'justify-start' }}">
            <div class="max-w-[80%] sm:max-w-[70%] rounded-xl px-4 py-2.5 text-sm leading-relaxed
                        {% if msg.direction == 'outgoing' %}
                          {% if reservation.contact_platform == 'line' %}
                            bg-[#06c755] text-white rounded-br-sm
                          {% else %}
                            bg-[#fee500] text-[#1e1e1e] rounded-br-sm
                          {% endif %}
                        {% else %}
                          bg-muted text-foreground border border-border rounded-bl-sm
                        {% endif %}">
              {{ msg.content }}
              <div class="mt-1 text-[10px] opacity-70 tabular-nums">
                {{ msg.created_at[:19] if msg.created_at else '' }}
                {% if msg.llm_provider %}
                  <span class="ml-1">via {{ msg.llm_provider }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% else %}
          <div class="flex flex-col items-center justify-center py-10 text-muted-foreground">
            <i data-lucide="message-square-off" class="w-8 h-8 mb-2 opacity-40"></i>
            <p class="text-sm">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ë¦¬ê°€ ì‹œì‘ë˜ë©´ ë´‡ì´ í´ë¦¬ë‹‰ì— ì—°ë½í•©ë‹ˆë‹¤.</p>
          </div>
          {% endfor %}
        </div>

        {% if reservation.status in ('paused_for_human', 'negotiating', 'greeting_sent') %}
        <form method="POST" action="/reservations/{{ reservation.id }}/resume" class="mt-4 flex gap-2 items-end">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <textarea name="message"
                    placeholder="í´ë¦¬ë‹‰ì— ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    required
                    rows="2"
                    class="flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-y min-h-[60px]"></textarea>
          <button type="submit"
                  class="inline-flex items-center gap-1.5 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 self-end"
                  aria-label="ë©”ì‹œì§€ ì „ì†¡">
            <i data-lucide="send" class="w-4 h-4"></i>
            ì „ì†¡
          </button>
        </form>
        {% endif %}
      </div>
    </div>
  </main>

  <script>
    lucide.createIcons();

    function copyForPatient() {
      const summary = document.getElementById('patient-summary');
      const msg = document.getElementById('copied-msg');
      const text = summary.textContent.trim();
      navigator.clipboard.writeText(text).then(function() {
        msg.classList.remove('hidden');
        setTimeout(function() { msg.classList.add('hidden'); }, 2000);
      });
    }
  </script>
</body>
</html>
