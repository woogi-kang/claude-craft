<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservation Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: #64748b; margin-bottom: 24px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .btn { display: inline-block; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; border: none; cursor: pointer; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-outline { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
    .btn-outline:hover { background: #eff6ff; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .filters a { padding: 6px 14px; border-radius: 20px; text-decoration: none; font-size: 13px; background: white; color: #475569; border: 1px solid #e2e8f0; }
    .filters a.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .alert-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    th { background: #f1f5f9; padding: 12px 16px; text-align: left; font-size: 13px; color: #64748b; font-weight: 600; }
    td { padding: 12px 16px; border-top: 1px solid #f1f5f9; font-size: 14px; }
    tr:hover td { background: #f8fafc; }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; }
    .clinic-name { font-weight: 600; color: #1e293b; text-decoration: none; }
    .clinic-name:hover { color: #3b82f6; }
    .meta { color: #94a3b8; font-size: 13px; }
    .empty { text-align: center; padding: 48px; color: #94a3b8; }
    .platform-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .platform-tag.kakao { background: #fee500; color: #3c1e1e; }
    .platform-tag.line { background: #06c755; color: white; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #1e293b; }
    .stat-label { font-size: 12px; color: #94a3b8; margin-top: 2px; }
    .stat-card.active .stat-value { color: #3b82f6; }
    .stat-card.confirmed .stat-value { color: #10b981; }
    .stat-card.paused .stat-value { color: #ef4444; }
    @media (max-width: 768px) {
      .container { padding: 12px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      table { font-size: 13px; }
      th, td { padding: 8px 10px; }
      .filters { flex-wrap: wrap; }
      .stats { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>Reservation Dashboard</h1>
        <p class="subtitle">Outbound clinic reservation management</p>
      </div>
      <div style="display:flex;gap:8px;">
        <a href="/export/csv" class="btn btn-outline btn-sm">CSV Export</a>
        <a href="/create" class="btn btn-primary">+ New Reservation</a>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card active">
        <div class="stat-value">{{ stats.active }}</div>
        <div class="stat-label">Active</div>
      </div>
      <div class="stat-card confirmed">
        <div class="stat-value">{{ stats.confirmed }}</div>
        <div class="stat-label">Confirmed</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ stats.declined }}</div>
        <div class="stat-label">Declined</div>
      </div>
      <div class="stat-card paused">
        <div class="stat-value">{{ stats.paused }}</div>
        <div class="stat-label">Paused</div>
      </div>
    </div>

    {% if paused_count > 0 %}
    <div class="alert alert-warning">
      {{ paused_count }} reservation(s) paused and waiting for your action.
      <a href="/?status=paused_for_human" style="font-weight:600;">View</a>
    </div>
    {% endif %}

    <div class="filters">
      <a href="/" class="{{ 'active' if not current_status else '' }}">All</a>
      <a href="/?status=created" class="{{ 'active' if current_status == 'created' else '' }}">Created</a>
      <a href="/?status=negotiating" class="{{ 'active' if current_status == 'negotiating' else '' }}">Negotiating</a>
      <a href="/?status=paused_for_human" class="{{ 'active' if current_status == 'paused_for_human' else '' }}">Paused</a>
      <a href="/?status=confirmed" class="{{ 'active' if current_status == 'confirmed' else '' }}">Confirmed</a>
      <a href="/?status=completed" class="{{ 'active' if current_status == 'completed' else '' }}">Completed</a>
      <a href="/?status=declined" class="{{ 'active' if current_status == 'declined' else '' }}">Declined</a>
    </div>

    <table style="margin-top:16px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Clinic</th>
          <th>Patient</th>
          <th>Procedure</th>
          <th>Dates</th>
          <th>Status</th>
          <th>Result</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reservations %}
        <tr>
          <td class="meta">{{ r.request_id }}</td>
          <td>
            <a href="/reservations/{{ r.id }}" class="clinic-name">{{ r.clinic_name }}</a>
            {% if r.clinic_contact_url %}
              {% if r.contact_platform == 'line' %}
                <span class="platform-tag line">LINE</span>
              {% else %}
                <span class="platform-tag kakao">KT</span>
              {% endif %}
            {% endif %}
          </td>
          <td>
            {{ r.patient_name }}
            <span class="meta">({{ r.patient_nationality }})</span>
          </td>
          <td>{{ r.procedure_name }}</td>
          <td class="meta">
            {% if r.preferred_dates %}
              {% set dates = json_loads(r.preferred_dates) if r.preferred_dates.startswith('[') else [r.preferred_dates] %}
              {{ dates | join(', ') }}
            {% endif %}
          </td>
          <td>
            {% set b = badge(r.status) %}
            <span class="badge" style="background:{{ b.color }}">{{ b.label }}</span>
          </td>
          <td>
            {% if r.confirmed_date %}
              {{ r.confirmed_date }} {{ r.confirmed_time or '' }}
              {% if r.confirmed_price %}<br><span class="meta">{{ r.confirmed_price }}</span>{% endif %}
            {% elif r.decline_reason %}
              <span class="meta">{{ r.decline_reason[:30] }}</span>
            {% endif %}
          </td>
          <td class="meta">{{ r.created_at[:10] if r.created_at else '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="empty">No reservations yet. <a href="/create">Create one</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
