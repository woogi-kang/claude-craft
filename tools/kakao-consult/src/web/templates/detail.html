<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservation {{ reservation.request_id }}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; }
    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    .back { color: #3b82f6; text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 16px; }
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    h1 { font-size: 22px; }
    .request-id { color: #94a3b8; font-size: 14px; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; color: white; }
    .actions { display: flex; gap: 8px; }
    .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; border: none; cursor: pointer; text-decoration: none; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }
    .btn-success { background: #d1fae5; color: #059669; }
    .btn-success:hover { background: #a7f3d0; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; }
    .card-title { font-size: 14px; font-weight: 700; color: #3b82f6; margin-bottom: 12px; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .info-item label { font-size: 12px; color: #94a3b8; display: block; }
    .info-item span { font-size: 14px; font-weight: 500; }
    .result-box { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin-top: 12px; }
    .result-box.declined { background: #fef2f2; border-color: #fecaca; }
    .chat { margin-top: 16px; }
    .chat-msg { padding: 12px 16px; border-radius: 12px; margin-bottom: 8px; max-width: 80%; font-size: 14px; line-height: 1.5; }
    .chat-msg.outgoing { background: #fee500; color: #1e1e1e; margin-left: auto; border-bottom-right-radius: 4px; }
    .chat-msg.incoming { background: white; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
    .chat-msg .meta { font-size: 11px; color: #94a3b8; margin-top: 4px; }
    .chat-msg .provider { font-size: 11px; color: #3b82f6; }
    .resume-form { margin-top: 16px; display: flex; gap: 8px; }
    .resume-form textarea { flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px; }
    .resume-form button { align-self: flex-end; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .resume-form button:hover { background: #2563eb; }
    .pause-alert { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 14px; color: #92400e; }
    .empty-chat { text-align: center; padding: 32px; color: #94a3b8; font-size: 14px; }
    .btn-copy { background: #eff6ff; color: #3b82f6; border: 1px solid #bfdbfe; }
    .btn-copy:hover { background: #dbeafe; }
    .copy-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-top: 12px; font-size: 14px; white-space: pre-wrap; line-height: 1.6; }
    .copied-msg { color: #10b981; font-size: 12px; margin-left: 8px; display: none; }
    @media (max-width: 768px) {
      .container { padding: 12px; }
      .header { flex-direction: column; }
      .info-grid { grid-template-columns: 1fr; }
      .chat-msg { max-width: 95%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back">&larr; Dashboard</a>

    <div class="header">
      <div>
        <h1>{{ reservation.clinic_name }}</h1>
        <span class="request-id">{{ reservation.request_id }}</span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        {% set b = badge(reservation.status) %}
        <span class="badge" style="background:{{ b.color }}">{{ b.label }}</span>
        <div class="actions">
          {% if reservation.status == 'confirmed' %}
          <form method="POST" action="/reservations/{{ reservation.id }}/complete" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-success">Mark Completed</button>
          </form>
          {% endif %}
          {% if reservation.status not in ('completed', 'failed', 'declined') %}
          <form method="POST" action="/reservations/{{ reservation.id }}/cancel" style="display:inline;"
                onsubmit="return confirm('Cancel this reservation?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger">Cancel</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    {% if reservation.status == 'paused_for_human' %}
    <div class="pause-alert">
      This reservation is paused: <strong>{{ reservation.paused_reason or 'Needs human review' }}</strong>.
      Use the form below to send a manual message and resume.
    </div>
    {% endif %}

    <!-- Reservation Info -->
    <div class="card">
      <div class="card-title">Reservation Details</div>
      <div class="info-grid">
        <div class="info-item">
          <label>Procedure</label>
          <span>{{ reservation.procedure_name }}</span>
        </div>
        <div class="info-item">
          <label>Preferred Dates</label>
          <span>
            {% if reservation.preferred_dates %}
              {% set dates = json_loads(reservation.preferred_dates) if reservation.preferred_dates and reservation.preferred_dates.startswith('[') else [reservation.preferred_dates] %}
              {{ dates | join(', ') }}
            {% else %}
              -
            {% endif %}
          </span>
        </div>
        <div class="info-item">
          <label>Preferred Time</label>
          <span>{{ reservation.preferred_time or 'Any' }}</span>
        </div>
        <div class="info-item">
          <label>Turns</label>
          <span>{{ reservation.turn_count or 0 }}</span>
        </div>
      </div>
    </div>

    <!-- Patient Info -->
    <div class="card">
      <div class="card-title">Patient</div>
      <div class="info-grid">
        <div class="info-item">
          <label>Name</label>
          <span>{{ reservation.patient_name }}</span>
        </div>
        <div class="info-item">
          <label>Nationality</label>
          <span>{{ reservation.patient_nationality }}</span>
        </div>
        <div class="info-item">
          <label>Age</label>
          <span>{{ reservation.patient_age or '-' }}</span>
        </div>
        <div class="info-item">
          <label>Gender</label>
          <span>{{ reservation.patient_gender or '-' }}</span>
        </div>
        <div class="info-item">
          <label>Contact</label>
          <span>{{ reservation.patient_contact or '-' }}</span>
        </div>
        <div class="info-item">
          <label>Notes</label>
          <span>{{ reservation.notes or '-' }}</span>
        </div>
      </div>
    </div>

    <!-- Result (if confirmed/declined) -->
    {% if reservation.status in ('confirmed', 'completed') and reservation.confirmed_date %}
    <div class="card">
      <div class="card-title">Reservation Result</div>
      <div class="result-box">
        <div class="info-grid">
          <div class="info-item">
            <label>Date</label>
            <span>{{ reservation.confirmed_date }}</span>
          </div>
          <div class="info-item">
            <label>Time</label>
            <span>{{ reservation.confirmed_time or '-' }}</span>
          </div>
          <div class="info-item">
            <label>Price</label>
            <span>{{ reservation.confirmed_price or '-' }}</span>
          </div>
          <div class="info-item">
            <label>Doctor</label>
            <span>{{ reservation.confirmed_doctor or '-' }}</span>
          </div>
        </div>
        {% if reservation.clinic_instructions %}
        <div style="margin-top:12px;">
          <label style="font-size:12px;color:#94a3b8;">Clinic Instructions</label>
          <p style="font-size:14px;margin-top:4px;">{{ reservation.clinic_instructions }}</p>
        </div>
        {% endif %}
      </div>
      <div style="margin-top:12px;display:flex;align-items:center;">
        <button class="btn btn-copy" onclick="copyForPatient()">Copy for Patient</button>
        <span class="copied-msg" id="copied-msg">Copied!</span>
      </div>
      <div class="copy-box" id="patient-summary" style="display:none;">Clinic: {{ reservation.clinic_name }}
Date: {{ reservation.confirmed_date }}
Time: {{ reservation.confirmed_time or 'TBD' }}
Procedure: {{ reservation.procedure_name }}{% if reservation.confirmed_price %}
Price: {{ reservation.confirmed_price }}{% endif %}{% if reservation.confirmed_doctor %}
Doctor: {{ reservation.confirmed_doctor }}{% endif %}{% if reservation.clinic_instructions %}
Notes: {{ reservation.clinic_instructions }}{% endif %}</div>
    </div>
    {% elif reservation.status == 'declined' %}
    <div class="card">
      <div class="card-title">Declined</div>
      <div class="result-box declined">
        <p>{{ reservation.decline_reason or 'No reason provided' }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Conversation Log -->
    <div class="card">
      <div class="card-title">Conversation Log</div>
      <div class="chat">
        {% for msg in messages %}
        <div class="chat-msg {{ msg.direction }}">
          {{ msg.content }}
          <div class="meta">
            {{ msg.created_at[:19] if msg.created_at else '' }}
            {% if msg.llm_provider %}
              <span class="provider">via {{ msg.llm_provider }}</span>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="empty-chat">No messages yet. Bot will contact the clinic when processing starts.</div>
        {% endfor %}
      </div>

      {% if reservation.status in ('paused_for_human', 'negotiating', 'greeting_sent') %}
      <form method="POST" action="/reservations/{{ reservation.id }}/resume" class="resume-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <textarea name="message" placeholder="Type a message to send to the clinic..." required></textarea>
        <button type="submit">Send</button>
      </form>
      {% endif %}
    </div>
  </div>
  <script>
    function copyForPatient() {
      const summary = document.getElementById('patient-summary');
      const msg = document.getElementById('copied-msg');
      const text = summary.textContent.trim();
      navigator.clipboard.writeText(text).then(function() {
        msg.style.display = 'inline';
        setTimeout(function() { msg.style.display = 'none'; }, 2000);
      });
    }
  </script>
</body>
</html>
