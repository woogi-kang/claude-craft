<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Reservation</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; }
    .container { max-width: 640px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin-bottom: 4px; }
    .subtitle { color: #64748b; margin-bottom: 24px; }
    .back { color: #3b82f6; text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 16px; }
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .section { margin-bottom: 24px; }
    .section-title { font-size: 14px; font-weight: 700; color: #3b82f6; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #eff6ff; }
    .field { margin-bottom: 16px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    textarea { resize: vertical; min-height: 80px; }
    .hint { font-size: 12px; color: #94a3b8; margin-top: 4px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; text-decoration: none; }
    .btn-primary { background: #3b82f6; color: white; width: 100%; }
    .btn-primary:hover { background: #2563eb; }
    .autocomplete-wrapper { position: relative; }
    .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
    .autocomplete-item:hover { background: #f8fafc; }
    .autocomplete-item .name { font-weight: 600; }
    .autocomplete-item .meta { font-size: 12px; color: #94a3b8; }
    .kakao-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #fee500; margin-left: 4px; }
    @media (max-width: 768px) {
      .container { padding: 12px; }
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back">&larr; Dashboard</a>
    <h1>New Reservation</h1>
    <p class="subtitle">Create a reservation request for a foreign patient</p>

    <form method="POST" action="/create" class="card">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="section">
        <div class="section-title">Clinic Information</div>
        <div class="field autocomplete-wrapper">
          <label for="clinic_name">Clinic Name *</label>
          <input type="text" id="clinic_name" name="clinic_name" required
                 placeholder="Search clinic name..." autocomplete="off">
          <div id="clinic-list" class="autocomplete-list"></div>
          <div class="hint">Type to search from 1,106 clinics with KakaoTalk</div>
        </div>
        <div class="field">
          <label for="procedure_name">Procedure *</label>
          <input type="text" id="procedure_name" name="procedure_name" required
                 placeholder="e.g. Botox, Laser Toning, Filler">
        </div>
      </div>

      <div class="section">
        <div class="section-title">Schedule</div>
        <div class="field">
          <label for="preferred_dates">Preferred Dates</label>
          <input type="text" id="preferred_dates" name="preferred_dates"
                 placeholder="e.g. 2026-03-15, 2026-03-16">
          <div class="hint">Comma-separated YYYY-MM-DD</div>
        </div>
        <div class="field">
          <label for="preferred_time">Preferred Time</label>
          <select id="preferred_time" name="preferred_time">
            <option value="any">Any time</option>
            <option value="morning">Morning (AM)</option>
            <option value="afternoon">Afternoon (PM)</option>
          </select>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Patient Information</div>
        <div class="row">
          <div class="field">
            <label for="patient_name">Patient Name *</label>
            <input type="text" id="patient_name" name="patient_name" required>
          </div>
          <div class="field">
            <label for="patient_nationality">Nationality</label>
            <select id="patient_nationality" name="patient_nationality">
              <option value="JP">Japan</option>
              <option value="CN">China</option>
              <option value="TW">Taiwan</option>
              <option value="MY">Malaysia</option>
              <option value="US">USA</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="patient_age">Age</label>
            <input type="number" id="patient_age" name="patient_age"
                   min="1" max="120" placeholder="e.g. 35">
          </div>
          <div class="field">
            <label for="patient_gender">Gender</label>
            <select id="patient_gender" name="patient_gender">
              <option value="">Not specified</option>
              <option value="F">Female</option>
              <option value="M">Male</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label for="patient_contact">Contact Info</label>
          <input type="text" id="patient_contact" name="patient_contact"
                 placeholder="e.g. LINE: tanaka_yuki">
        </div>
      </div>

      <div class="section">
        <div class="section-title">Notes</div>
        <div class="field">
          <textarea id="notes" name="notes"
                    placeholder="Any additional requests or instructions..."></textarea>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Create Reservation</button>
    </form>
  </div>

  <script>
    const clinicInput = document.getElementById('clinic_name');
    const clinicList = document.getElementById('clinic-list');
    let debounceTimer;

    function createAutocompleteItem(clinic) {
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.dataset.name = clinic.name;

      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = clinic.name;
      div.appendChild(nameSpan);

      if (clinic.has_kakao) {
        const dot = document.createElement('span');
        dot.className = 'kakao-dot';
        dot.title = 'KakaoTalk available';
        div.appendChild(dot);
      }

      div.appendChild(document.createElement('br'));

      const metaSpan = document.createElement('span');
      metaSpan.className = 'meta';
      metaSpan.textContent = clinic.address || '';
      div.appendChild(metaSpan);

      return div;
    }

    clinicInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const q = this.value.trim();
      if (q.length < 1) { clinicList.style.display = 'none'; return; }
      debounceTimer = setTimeout(() => {
        fetch('/api/clinics/search?q=' + encodeURIComponent(q))
          .then(r => r.json())
          .then(data => {
            if (data.length === 0) { clinicList.style.display = 'none'; return; }
            clinicList.replaceChildren();
            data.forEach(c => clinicList.appendChild(createAutocompleteItem(c)));
            clinicList.style.display = 'block';
          });
      }, 200);
    });

    clinicList.addEventListener('click', function(e) {
      const item = e.target.closest('.autocomplete-item');
      if (item) {
        clinicInput.value = item.dataset.name;
        clinicList.style.display = 'none';
      }
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.autocomplete-wrapper')) {
        clinicList.style.display = 'none';
      }
    });
  </script>
</body>
</html>
